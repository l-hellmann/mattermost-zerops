mattermost:
  build:
    base: [ ubuntu@22.04 ]
    build: [ ]
    deploy: [ "." ] 
    addToRunPrepare: [ "config.json" ]

  run:
    prepare:
      - curl -o- https://deb.packages.mattermost.com/repo-setup.sh | sudo bash -s mattermost
      - apt-get update
      - apt-get install mattermost postgresql-client -y
      - echo $pgdb_hostname:$pgdb_port:$pgdb_hostname:$pgdb_user:$pgdb_password > /root/.pgpass
      - chmod 0600 /root/.pgpass
    envReplace:
     target: config.json
     delimiter: '%%'
    init:
      - rm /opt/mattermost/config/config.json
      - bash -x migrate.sh
    start: mattermost -c config.json